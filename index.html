<!doctype html>

<html lang="pt-br" dir="ltr" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <meta name="author" content="Raphael Laurentino" />
    <meta
      name="description"
      content="Raphael Laurentino é Desenvolvedor Front-End em São Paulo com experiência em React, JavaScript, Node.js e Laravel. Criação de interfaces modernas, performáticas e escaláveis."
    />
    <meta
      name="keywords"
      content="Raphael Laurentino, Desenvolvedor Front-End São Paulo, React Developer SP, Desenvolvedor Web São Paulo"
    />
    <meta name="robots" content="index, follow" />

    <title>Mercadinho do Mês</title>

    <!-- Bootstrap 5 + Ícones -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      /* Ajustes personalizados para melhor experiência */
      .item-row {
        background-color: rgba(0, 0, 0, 0.02);
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        transition: background-color 0.2s;
      }
      [data-bs-theme='dark'] .item-row {
        background-color: rgba(255, 255, 255, 0.05);
      }
      .price-input {
        max-width: 120px;
      }
      .total-card {
        font-size: 1.5rem;
        font-weight: 600;
        border: none;
        background: linear-gradient(135deg, #0d6efd, #0b5ed7);
        color: white;
      }
      .history-table th,
      .history-table td {
        vertical-align: middle;
      }
      .btn-circle {
        border-radius: 50%;
        width: 38px;
        height: 38px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      /* Ajuste para inputs em dispositivos pequenos */
      @media (max-width: 576px) {
        .item-row .row {
          --bs-gutter-y: 0.5rem;
        }
        .price-input {
          max-width: 100%;
        }
      }
    </style>
  </head>

  <body class="p-3">
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js'
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: 'AIzaSyCWpmX8CgGJOIgjDBXAOiXNucFhlXRF2cU',
        authDomain: 'myapplication-a539392a.firebaseapp.com',
        projectId: 'myapplication-a539392a',
        storageBucket: 'myapplication-a539392a.firebasestorage.app',
        messagingSenderId: '858554533426',
        appId: '1:858554533426:web:02475b67af7a7a8c461e2b',
      }

      // Initialize Firebase
      const app = initializeApp(firebaseConfig)
    </script>

    <div class="container-lg py-3">
      <!-- Cabeçalho com título e botão de tema -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="bi bi-cart-check me-2"></i>Compras do Mês</h1>
        <button class="btn btn-outline-secondary" id="themeToggle" title="Alternar tema">
          <i class="bi bi-sun-fill"></i> <i class="bi bi-moon-fill"></i>
        </button>
      </div>

      <!-- Formulário para adicionar novo item -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="row g-2">
            <div class="col-12 col-sm-8 col-md-9">
              <input
                type="text"
                class="form-control"
                id="newItemName"
                placeholder="Digite o nome do item..."
              />
            </div>
            <div class="col-12 col-sm-4 col-md-3">
              <button class="btn btn-primary w-100" id="addItemBtn">
                <i class="bi bi-plus-circle me-1"></i>Adicionar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de itens da compra atual -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-transparent fw-bold">
          <i class="bi bi-list-check me-2"></i>Itens a comprar
        </div>
        <div class="card-body" id="itemsContainer">
          <!-- Itens serão inseridos dinamicamente aqui -->
          <p class="text-muted text-center mb-0" id="emptyMessage">Nenhum item adicionado ainda.</p>
        </div>
        <!-- Card total sempre visível -->
        <div class="card-footer bg-transparent">
          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold">Total estimado:</span>
            <span class="h4 mb-0" id="totalAmount">R$ 0,00</span>
          </div>
        </div>
      </div>

      <!-- Ações do mês atual -->
      <div class="d-flex flex-wrap gap-2 mb-4">
        <button class="btn btn-success" id="archiveMonthBtn">
          <i class="bi bi-archive me-1"></i>Arquivar mês e começar novo
        </button>
      </div>

      <!-- Histórico de meses anteriores -->
      <div class="card shadow-sm">
        <div
          class="card-header bg-transparent fw-bold d-flex flex-wrap align-items-center justify-content-between"
        >
          <span><i class="bi bi-calendar2-month me-2"></i>Histórico mensal</span>
          <button class="btn btn-sm btn-outline-secondary" id="exportHistoryBtn">
            <i class="bi bi-file-spreadsheet me-1"></i>Exportar para CSV
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover history-table align-middle" id="historyTable">
              <thead>
                <tr>
                  <th>Mês/Ano</th>
                  <th>Total gasto</th>
                  <th class="text-end">Ações</th>
                </tr>
              </thead>
              <tbody id="historyBody">
                <!-- Histórico será preenchido via JS -->
              </tbody>
              <tfoot>
                <tr class="fw-bold">
                  <td>Média geral</td>
                  <td id="averageSpending">R$ 0,00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção: carregar CSV acessível (ex: /excel.csv) -->
    <div class="container-lg py-3">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title">Carregar CSV do servidor (uso como banco)</h5>
          <p class="card-text">
            Se houver um arquivo `excel.csv` na raiz do site, clique para carregar e salvar em cache
            (IndexedDB).
          </p>
          <div class="d-flex gap-2">
            <button id="loadPathBtn" class="btn btn-outline-primary">Carregar /excel.csv</button>
            <button id="clearCacheBtn" class="btn btn-outline-secondary">
              Limpar cache (datasets)
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para editar nome do item -->
    <div class="modal fade" id="editItemModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar item</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Fechar"
            ></button>
          </div>
          <div class="modal-body">
            <input type="text" class="form-control" id="editItemName" placeholder="Novo nome" />
            <input type="hidden" id="editItemId" />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="saveEditBtn">Salvar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (necessário para modal e tema) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
      ;(function () {
        // ----- Estruturas de dados -----
        // Mês atual: { year, month, items: [ { id, name, bought, price } ] }
        let currentMonth = {
          year: new Date().getFullYear(),
          month: new Date().getMonth(),
          items: [],
        }

        // Histórico: [ { year, month, total } ]
        let history = []

        // ----- Inicialização (carregar do localStorage) -----
        function loadFromStorage() {
          const savedCurrent = localStorage.getItem('shoppingCurrentMonth')
          if (savedCurrent) {
            try {
              const parsed = JSON.parse(savedCurrent)
              // garantir que items existe
              currentMonth = parsed
              if (!currentMonth.items) currentMonth.items = []
            } catch (e) {
              console.warn('Erro ao carregar mês atual')
            }
          } else {
            // Inicia com mês atual vazio
            currentMonth = {
              year: new Date().getFullYear(),
              month: new Date().getMonth(),
              items: [],
            }
          }

          const savedHistory = localStorage.getItem('shoppingHistory')
          if (savedHistory) {
            try {
              history = JSON.parse(savedHistory)
            } catch (e) {
              console.warn('Erro ao carregar histórico')
            }
          } else {
            // Dados fictícios para demonstração
            history = [
              { year: 2025, month: 3, total: 450.75 }, // Abril (mês 3 = abril)
              { year: 2025, month: 4, total: 620.3 }, // Maio
              { year: 2025, month: 5, total: 387.9 }, // Junho
            ]
          }
        }

        function saveToStorage() {
          localStorage.setItem('shoppingCurrentMonth', JSON.stringify(currentMonth))
          localStorage.setItem('shoppingHistory', JSON.stringify(history))
        }

        // ----- Utilitários de formatação -----
        function formatMonthYear(year, month) {
          const date = new Date(year, month, 1)
          return date
            .toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })
            .replace(/^[a-z]/, (l) => l.toUpperCase())
        }

        function formatCurrency(value) {
          return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
        }

        // ----- Cálculo do total atual -----
        function calculateTotal() {
          return currentMonth.items.reduce(
            (sum, item) => (item.bought ? sum + (item.price || 0) : sum),
            0,
          )
        }

        // ----- Atualizar interface da lista de itens e total -----
        function renderItems() {
          const container = document.getElementById('itemsContainer')
          const totalSpan = document.getElementById('totalAmount')
          const emptyMsg = document.getElementById('emptyMessage')

          if (currentMonth.items.length === 0) {
            container.innerHTML =
              '<p class="text-muted text-center mb-0" id="emptyMessage">Nenhum item adicionado ainda.</p>'
            totalSpan.textContent = formatCurrency(0)
            return
          }

          let html = ''
          currentMonth.items.forEach((item) => {
            const checked = item.bought ? 'checked' : ''
            const priceField = item.bought
              ? `<input type="number" class="form-control form-control-sm price-input" step="0.01" min="0" value="${item.price || 0}" data-id="${item.id}" data-field="price">`
              : '<span class="text-muted small">—</span>'

            html += `
                    <div class="item-row" data-id="${item.id}">
                        <div class="row align-items-center g-2">
                            <div class="col-12 col-sm-5 col-md-4">
                                <span class="fw-bold">${item.name}</span>
                            </div>
                            <div class="col-6 col-sm-3 col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input item-bought" type="checkbox" data-id="${item.id}" ${checked}>
                                    <label class="form-check-label">Pego</label>
                                </div>
                            </div>
                            <div class="col-6 col-sm-3 col-md-3">
                                ${priceField}
                            </div>
                            <div class="col-12 col-sm-1 col-md-2 text-end">
                                <button class="btn btn-sm btn-outline-primary btn-circle edit-item" data-id="${item.id}" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-circle delete-item" data-id="${item.id}" title="Excluir">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `
          })

          container.innerHTML = html
          totalSpan.textContent = formatCurrency(calculateTotal())
        }

        // ----- Atualizar tabela de histórico e média -----
        function renderHistory() {
          const tbody = document.getElementById('historyBody')
          const avgSpan = document.getElementById('averageSpending')

          if (history.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="3" class="text-center text-muted">Nenhum mês arquivado.</td></tr>'
            avgSpan.textContent = formatCurrency(0)
            return
          }

          // Ordenar do mais recente para o mais antigo
          const sorted = [...history].sort((a, b) => b.year - a.year || b.month - a.month)

          let rows = ''
          let sum = 0
          sorted.forEach((entry) => {
            sum += entry.total
            rows += `
                    <tr>
                        <td>${formatMonthYear(entry.year, entry.month)}</td>
                        <td>${formatCurrency(entry.total)}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-danger delete-history" data-year="${entry.year}" data-month="${entry.month}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `
          })

          tbody.innerHTML = rows
          const average = history.length > 0 ? sum / history.length : 0
          avgSpan.textContent = formatCurrency(average)
        }

        // ----- Adicionar item -----
        function addItem(name) {
          if (!name.trim()) return
          const newItem = {
            id: Date.now() + Math.random().toString(36).substr(2, 5),
            name: name.trim(),
            bought: false,
            price: 0,
          }
          currentMonth.items.push(newItem)
          saveToStorage()
          renderItems()
        }

        // ----- Excluir item -----
        function deleteItem(id) {
          currentMonth.items = currentMonth.items.filter((item) => item.id != id)
          saveToStorage()
          renderItems()
        }

        // ----- Editar item (nome) -----
        function editItem(id, newName) {
          const item = currentMonth.items.find((item) => item.id == id)
          if (item && newName.trim()) {
            item.name = newName.trim()
            saveToStorage()
            renderItems()
          }
        }

        // ----- Atualizar campo (bought ou price) via eventos delegados -----
        function handleItemChange(e) {
          const target = e.target
          if (target.classList.contains('item-bought')) {
            // Checkbox marcado/desmarcado
            const id = target.dataset.id
            const item = currentMonth.items.find((item) => item.id == id)
            if (item) {
              item.bought = target.checked
              if (!item.bought) {
                item.price = 0 // zera preço se desmarcar
              } else if (!item.price) {
                item.price = 0 // garante que existe
              }
              saveToStorage()
              renderItems()
            }
          } else if (target.dataset.field === 'price') {
            // Input de preço alterado
            const id = target.dataset.id
            const item = currentMonth.items.find((item) => item.id == id)
            if (item) {
              const val = parseFloat(target.value)
              item.price = isNaN(val) ? 0 : val
              saveToStorage()
              // Atualiza total sem re-renderizar tudo (mas re-renderizar é seguro)
              renderItems()
            }
          }
        }

        // ----- Arquivar mês atual e limpar lista -----
        function archiveMonth() {
          if (currentMonth.items.length === 0) {
            showToast('Adicione itens antes de arquivar o mês.', 'warning')
            return
          }

          const total = calculateTotal()
          const newHistoryEntry = {
            year: currentMonth.year,
            month: currentMonth.month,
            total: total,
          }
          history.push(newHistoryEntry)
          // Iniciar novo mês
          const now = new Date()
          currentMonth = {
            year: now.getFullYear(),
            month: now.getMonth(),
            items: [],
          }
          saveToStorage()
          renderItems()
          renderHistory()
        }

        // ----- Excluir entrada do histórico -----
        function deleteHistoryEntry(year, month) {
          history = history.filter((entry) => !(entry.year === year && entry.month === month))
          saveToStorage()
          renderHistory()
        }

        // ----- Exportar histórico para CSV -----
        function exportHistoryToCSV() {
          if (history.length === 0) {
            showToast('Nenhum histórico para exportar.', 'warning')
            return
          }

          const sorted = [...history].sort((a, b) => a.year - b.year || a.month - b.month)
          let csv = 'Mês/Ano;Total (R$)\n'
          sorted.forEach((entry) => {
            const monthName = formatMonthYear(entry.year, entry.month)
            csv += `${monthName};${entry.total.toFixed(2).replace('.', ',')}\n`
          })

          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })
          const link = document.createElement('a')
          const url = URL.createObjectURL(blob)
          link.href = url
          link.setAttribute('download', 'historico_compras.csv')
          document.body.appendChild(link)
          link.click()
          document.body.removeChild(link)
          URL.revokeObjectURL(url)
        }

        // ----- Alternar tema claro/escuro -----
        function initThemeToggle() {
          const btn = document.getElementById('themeToggle')
          const html = document.documentElement
          btn.addEventListener('click', () => {
            const current = html.getAttribute('data-bs-theme')
            const newTheme = current === 'light' ? 'dark' : 'light'
            html.setAttribute('data-bs-theme', newTheme)
            // ícone já é trocado automaticamente via Bootstrap (mas não fere)
          })
        }

        // ----- Toasts (feedback visual) -----
        function showToast(message, variant = 'primary', delay = 3000) {
          try {
            let container = document.getElementById('toastContainer')
            if (!container) {
              container = document.createElement('div')
              container.id = 'toastContainer'
              container.className = 'position-fixed bottom-0 end-0 p-3'
              container.style.zIndex = 10800
              document.body.appendChild(container)
            }

            const toastEl = document.createElement('div')
            toastEl.className = 'toast align-items-center text-bg-' + variant
            toastEl.setAttribute('role', 'alert')
            toastEl.setAttribute('aria-live', 'assertive')
            toastEl.setAttribute('aria-atomic', 'true')

            toastEl.innerHTML = `
              <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
              </div>
            `

            container.appendChild(toastEl)
            const bsToast = new bootstrap.Toast(toastEl, { delay })
            bsToast.show()
            // remover após escondido
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove())
          } catch (e) {
            console.warn('showToast falhou', e)
          }
        }

        // ----- Carregar CSV por caminho (fetch) e salvar em IndexedDB -----
        async function loadCsvPath(path) {
          try {
            const res = await fetch(path)
            if (!res.ok) throw new Error('Falha ao buscar: ' + res.status)
            const text = await res.text()
            const parsed = Papa.parse(text, { header: true, skipEmptyLines: true })
            const rows = parsed.data
            await saveDataset(path, rows)
            showToast('CSV carregado e salvo em cache: ' + path, 'success')
            const list = await listDatasets()
            renderDatasets(list)
            showTable(rows)
          } catch (err) {
            showToast('Erro ao carregar CSV: ' + err.message, 'danger')
          }
        }

        // Limpar todos os datasets em cache (útil para testes)
        async function clearAllDatasets() {
          const db = await openDB()
          return new Promise((res, rej) => {
            const tx = db.transaction('datasets', 'readwrite')
            const store = tx.objectStore('datasets')
            const req = store.clear()
            req.onsuccess = () => res(true)
            req.onerror = (e) => rej(e.target.error)
          })
        }

        // ----- Inicialização -----
        document.addEventListener('DOMContentLoaded', function () {
          loadFromStorage()
          renderItems()
          renderHistory()

          // Event listeners
          document.getElementById('addItemBtn').addEventListener('click', () => {
            const input = document.getElementById('newItemName')
            addItem(input.value)
            input.value = ''
            input.focus()
          })

          document.getElementById('newItemName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              document.getElementById('addItemBtn').click()
            }
          })

          // Delegação de eventos para itens (bought, price, edit, delete)
          document.getElementById('itemsContainer').addEventListener('change', handleItemChange)
          document.getElementById('itemsContainer').addEventListener('click', (e) => {
            const target = e.target.closest('button')
            if (!target) return

            if (target.classList.contains('delete-item')) {
              const id = target.dataset.id
              if (confirm('Remover este item?')) {
                deleteItem(id)
              }
            } else if (target.classList.contains('edit-item')) {
              const id = target.dataset.id
              const item = currentMonth.items.find((i) => i.id == id)
              if (item) {
                document.getElementById('editItemId').value = id
                document.getElementById('editItemName').value = item.name
                const modal = new bootstrap.Modal(document.getElementById('editItemModal'))
                modal.show()
              }
            }
          })

          // Salvar edição do modal
          document.getElementById('saveEditBtn').addEventListener('click', () => {
            const id = document.getElementById('editItemId').value
            const newName = document.getElementById('editItemName').value
            editItem(id, newName)
            bootstrap.Modal.getInstance(document.getElementById('editItemModal')).hide()
          })

          // Arquivar mês
          document.getElementById('archiveMonthBtn').addEventListener('click', archiveMonth)

          // Histórico: exclusão e exportação
          document.getElementById('historyBody').addEventListener('click', (e) => {
            const btn = e.target.closest('button.delete-history')
            if (btn) {
              const year = parseInt(btn.dataset.year)
              const month = parseInt(btn.dataset.month)
              if (confirm('Remover este registro do histórico?')) {
                deleteHistoryEntry(year, month)
              }
            }
          })

          document.getElementById('exportHistoryBtn').addEventListener('click', exportHistoryToCSV)

          initThemeToggle()
          // Binders para carregar CSV remoto e limpar cache
          const loadPathBtn = document.getElementById('loadPathBtn')
          if (loadPathBtn)
            loadPathBtn.addEventListener('click', () => {
              loadCsvPath('/excel.csv')
            })

          const clearBtn = document.getElementById('clearCacheBtn')
          if (clearBtn)
            clearBtn.addEventListener('click', async () => {
              if (confirm('Limpar todos os datasets em cache?')) {
                await clearAllDatasets()
                renderDatasets([])
                document.getElementById('result').innerHTML = '<em>Cache limpo</em>'
              }
            })
            // Tentar carregar /excel.csv automaticamente se não estiver em cache
          ;(async () => {
            try {
              const listNow = await listDatasets()
              const has = listNow.some(
                (d) => d.name === '/excel.csv' || d.name.endsWith('/excel.csv'),
              )
              if (!has) {
                // não aguardar para não bloquear a renderização
                loadCsvPath('/excel.csv').catch(() => {
                  // falhas silenciosas (pode não existir em dev local)
                })
              }
            } catch (e) {
              // ignore
            }
          })()
        })
      })()
    </script>
  </body>
</html>
